<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng - BookStore</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../css/common.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="/user/index.html">
                <i class="bi bi-book"></i> BookStore
            </a>
            <div class="d-flex">
                <a href="/user/index.html" class="btn btn-outline-primary me-2">
                    <i class="bi bi-arrow-left"></i> Tiếp tục mua
                </a>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Cart Content -->
    <div class="container mt-4">
        <h2><i class="bi bi-cart"></i> Giỏ hàng của bạn</h2>
        
        <div class="row mt-4">
            <div class="col-md-8">
                <div id="cartItems">
                    <!-- Cart items will be loaded here -->
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Tổng đơn hàng</h5>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <span>Tổng sản phẩm:</span>
                            <span id="totalItems">0</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span>Tổng tiền:</span>
                            <h5 class="text-success" id="totalAmount">$0.00</h5>
                        </div>
                        <hr>
                        <button class="btn btn-success w-100" onclick="checkout()">
                            <i class="bi bi-credit-card"></i> Thanh toán
                        </button>
                        <button class="btn btn-outline-danger w-100 mt-2" onclick="clearCart()">
                            <i class="bi bi-trash"></i> Xóa tất cả
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/common.js"></script>
    <script>
            if (!localStorage.getItem('authToken')) {
        localStorage.setItem('authToken', 'fake-token-for-testing');
        localStorage.setItem('currentUser', JSON.stringify({
            id: 1,
            email: 'admin@test.com',
            fullName: 'Test Admin',
            role: 'Admin', // Đổi thành 'Customer' nếu test User
            avatarUrl: 'https://via.placeholder.com/40'
        }));
    }
            checkAuth();
        loadCart();
        
        async function loadCart() {
            try {
                const result = await apiCall('/cart');
                displayCart(result);
            } catch (error) {
                showAlert('Lỗi tải giỏ hàng', 'danger');
            }
        }
        
        function displayCart(cart) {
            const container = document.getElementById('cartItems');
            
            if (cart.Items.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-cart-x display-1 text-muted"></i>
                        <h4 class="mt-3">Giỏ hàng trống</h4>
                        <a href="/user/index.html" class="btn btn-primary mt-3">Mua sắm ngay</a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = cart.Items.map(item => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <img src="${item.BookCoverImg || 'https://via.placeholder.com/100'}" 
                                     class="img-fluid rounded">
                            </div>
                            <div class="col-md-5">
                                <h6>${item.BookTitle}</h6>
                                <p class="text-muted mb-0">${item.BookAuthor}</p>
                            </div>
                            <div class="col-md-2">
                                <input type="number" class="form-control" value="${item.Quantity}" 
                                       min="1" max="99" onchange="updateQuantity(${item.Id}, this.value)">
                            </div>
                            <div class="col-md-2">
                                <h6 class="text-success">${formatPrice(item.TotalPrice)}</h6>
                            </div>
                            <div class="col-md-1">
                                <button class="btn btn-sm btn-danger" onclick="removeItem(${item.Id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('totalItems').textContent = cart.TotalItems;
            document.getElementById('totalAmount').textContent = formatPrice(cart.TotalAmount);
        }
        
        async function updateQuantity(itemId, quantity) {
            try {
                await apiCall('/cart/update', {
                    method: 'PUT',
                    body: JSON.stringify({ CartItemId: itemId, Quantity: parseInt(quantity) })
                });
                loadCart();
            } catch (error) {
                showAlert('Lỗi cập nhật số lượng', 'danger');
            }
        }
        
        async function removeItem(itemId) {
            try {
                await apiCall(`/cart/remove/${itemId}`, { method: 'DELETE' });
                showAlert('Đã xóa khỏi giỏ hàng', 'success');
                loadCart();
            } catch (error) {
                showAlert('Lỗi xóa sản phẩm', 'danger');
            }
        }
        
        async function clearCart() {
            if (!confirm('Xóa tất cả sản phẩm trong giỏ?')) return;
            
            try {
                await apiCall('/cart/clear', { method: 'DELETE' });
                showAlert('Đã xóa toàn bộ giỏ hàng', 'success');
                loadCart();
            } catch (error) {
                showAlert('Lỗi xóa giỏ hàng', 'danger');
            }
        }
        
        function checkout() {
            alert('Chức năng thanh toán đang phát triển!');
        }
    </script>
</body>
</html>