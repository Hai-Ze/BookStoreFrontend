<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω s√°ch - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin/index.html">üìö BookStore Admin</a>
            <button class="btn btn-outline-light" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Qu·∫£n l√Ω s√°ch</h2>
            <button class="btn btn-success" onclick="showAddForm()">
                <i class="bi bi-plus"></i> Th√™m s√°ch
            </button>
        </div>

        <!-- Search -->
        <input type="search" class="form-control mb-3" placeholder="T√¨m ki·∫øm..." id="searchInput">

        <!-- Books Table -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>·∫¢nh</th>
                        <th>T√™n s√°ch</th>
                        <th>T√°c gi·∫£</th>
                        <th>Gi√°</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="booksTable">
                    <tr><td colspan="6" class="text-center">ƒêang t·∫£i...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav id="pagination"></nav>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal fade" id="bookModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Th√™m s√°ch</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="bookId">
                    <div class="mb-3">
                        <label>T√™n s√°ch *</label>
                        <input type="text" class="form-control" id="title" required>
                    </div>
                    <div class="mb-3">
                        <label>T√°c gi·∫£ *</label>
                        <input type="text" class="form-control" id="author" required>
                    </div>
                    <div class="mb-3">
                        <label>Gi√° *</label>
                        <input type="number" class="form-control" id="price" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label>URL ·∫¢nh b√¨a</label>
                        <input type="url" class="form-control" id="coverImg">
                    </div>
                    <div class="mb-3">
                        <label>M√¥ t·∫£</label>
                        <textarea class="form-control" id="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="saveBook()">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    //         if (!localStorage.getItem('authToken')) {
    //     localStorage.setItem('authToken', 'fake-token-for-testing');
    //     localStorage.setItem('currentUser', JSON.stringify({
    //         id: 1,
    //         email: 'admin@test.com',
    //         fullName: 'Test Admin',
    //         role: 'Admin', // ƒê·ªïi th√†nh 'Customer' n·∫øu test User
    //         avatarUrl: 'https://via.placeholder.com/40'
    //     }));
    // }
        const API_BASE = 'https://localhost:7288/api';
        let currentPage = 1;
        let isEditMode = false;

        // Check auth
        const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
        if (!user.role || user.role !== 'Admin') {
            alert('Kh√¥ng c√≥ quy·ªÅn!');
            window.location.href = '/login.html';
        }
        localStorage.setItem('authToken', 'fake-token-for-testing');
        // Load books
        async function loadBooks(page = 1) {
            currentPage = page;
            try {
                const res = await fetch(`${API_BASE}/BookApi/paged?page=${page}&pageSize=10`);
                const data = await res.json();
                displayBooks(data);
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }

        function displayBooks(data) {
            const tbody = document.getElementById('booksTable');
            tbody.innerHTML = data.Data.map(book => `
                <tr>
                    <td>${book.Id}</td>
                    <td><img src="${book.CoverImg || 'https://via.placeholder.com/50'}" width="50"></td>
                    <td>${book.Title}</td>
                    <td>${book.Author}</td>
                    <td>$${book.Price.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editBook(${book.Id})">S·ª≠a</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBook(${book.Id})">X√≥a</button>
                    </td>
                </tr>
            `).join('');

            // Pagination
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = `
                <ul class="pagination">
                    ${data.Page > 1 ? `<li class="page-item"><a class="page-link" href="#" onclick="loadBooks(${data.Page-1})">Tr∆∞·ªõc</a></li>` : ''}
                    <li class="page-item active"><a class="page-link">${data.Page} / ${data.TotalPages}</a></li>
                    ${data.Page < data.TotalPages ? `<li class="page-item"><a class="page-link" href="#" onclick="loadBooks(${data.Page+1})">Sau</a></li>` : ''}
                </ul>
            `;
        }

        function showAddForm() {
            isEditMode = false;
            document.getElementById('modalTitle').textContent = 'Th√™m s√°ch';
            document.getElementById('bookId').value = '';
            document.getElementById('title').value = '';
            document.getElementById('author').value = '';
            document.getElementById('price').value = '';
            document.getElementById('coverImg').value = '';
            document.getElementById('description').value = '';
            new bootstrap.Modal(document.getElementById('bookModal')).show();
        }

        async function editBook(id) {
            isEditMode = true;
            document.getElementById('modalTitle').textContent = 'S·ª≠a s√°ch';
            
            const res = await fetch(`${API_BASE}/BookApi/${id}`);
            const book = await res.json();
            
            document.getElementById('bookId').value = book.Id;
            document.getElementById('title').value = book.Title;
            document.getElementById('author').value = book.Author;
            document.getElementById('price').value = book.Price;
            document.getElementById('coverImg').value = book.CoverImg || '';
            document.getElementById('description').value = book.Description || '';
            
            new bootstrap.Modal(document.getElementById('bookModal')).show();
        }

        async function saveBook() {
            const token = localStorage.getItem('authToken');
            const bookData = {
                Id: isEditMode ? parseInt(document.getElementById('bookId').value) : 0,
                Title: document.getElementById('title').value,
                Author: document.getElementById('author').value,
                Price: parseFloat(document.getElementById('price').value),
                CoverImg: document.getElementById('coverImg').value,
                Description: document.getElementById('description').value
            };

            const method = isEditMode ? 'PUT' : 'POST';
            const url = isEditMode ? `${API_BASE}/BookApi/${bookData.Id}` : `${API_BASE}/BookApi`;

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(bookData)
                });

                if (res.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('bookModal')).hide();
                    loadBooks(currentPage);
                    alert(isEditMode ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m th√†nh c√¥ng!');
                } else {
                    alert('L·ªói: ' + res.statusText);
                }
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }

        async function deleteBook(id) {
            if (!confirm('X√°c nh·∫≠n x√≥a?')) return;
            
            const token = localStorage.getItem('authToken');
            try {
                const res = await fetch(`${API_BASE}/BookApi/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    loadBooks(currentPage);
                    alert('X√≥a th√†nh c√¥ng!');
                }
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/login.html';
        }

        // Search
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                if (e.target.value.length > 2) {
                    const res = await fetch(`${API_BASE}/BookApi/search?q=${e.target.value}&page=1&pageSize=10`);
                    const data = await res.json();
                    displayBooks(data);
                } else {
                    loadBooks(1);
                }
            }, 300);
        });

        // Load initial data
        loadBooks();
    </script>
</body>
</html>